<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuniKar </title>
    <meta name="description" content="TuniKar - Trouvez facilement votre itinéraire en bus dans le Grand Tunis. Recherche d'arrêts, lignes de bus et correspondances.">
    <meta name="keywords" content="bus tunis, transport tunis, transtu, itinéraire bus, grand tunis, tunisie transport">
    <meta name="author" content="Votre Nom">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:title" content="TuniKar - Guide des trajets en bus du Grand Tunis">
    <meta property="og:description" content="Trouvez facilement votre itinéraire en bus dans le Grand Tunis.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://votre-domaine.com">
    <meta property="og:image" content="https://votre-domaine.com/preview-image.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TuniKar - Guide des trajets en bus">
    <meta name="twitter:description" content="Trouvez votre itinéraire en bus dans le Grand Tunis.">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='5' y='5' width='90' height='90' rx='20' fill='%233D5A3D'/><path d='M25 25h20v8h-6v32h-8V33h-6z' fill='%23F5F1E8'/><path d='M55 25h8v15l12-15h10l-14 17 15 23h-10l-10-16-3 4v12h-8z' fill='%23C67B5C'/></svg>">

    
    <!-- Theme Color (mobile browser) -->
    <meta name="theme-color" content="#2C3E2D">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Earthy Color Palette */
            --earth-dark: #2C3E2D;
            --earth-forest: #3D5A3D;
            --earth-sage: #6B8E6B;
            --earth-olive: #8FA889;
            --earth-sand: #D4C4A8;
            --earth-cream: #F5F1E8;
            --earth-terracotta: #C67B5C;
            --earth-clay: #A65D3F;
            --earth-brown: #5D4E37;
            
            /* Functional Colors */
            --bg-primary: var(--earth-cream);
            --bg-secondary: #FFFFFF;
            --text-primary: var(--earth-dark);
            --text-secondary: var(--earth-brown);
            --accent: var(--earth-terracotta);
            --accent-hover: var(--earth-clay);
            --success: var(--earth-forest);
            --border: rgba(93, 78, 55, 0.15);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(44, 62, 45, 0.08);
            --shadow-md: 0 4px 20px rgba(44, 62, 45, 0.12);
            --shadow-lg: 0 8px 40px rgba(44, 62, 45, 0.16);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: var(--earth-dark);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .brand-name {
            font-family: 'DM Serif Display', serif;
            font-size: 1.75rem;
            color: var(--earth-cream);
            letter-spacing: 0.5px;
        }
        
        .brand-name span {
            color: var(--earth-terracotta);
        }
        
        .brand-tagline {
            font-size: 0.75rem;
            color: var(--earth-olive);
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        
        /* Left Panel */
        .left-panel {
            width: 420px;
            min-width: 380px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            position: relative;
            z-index: 100;
        }
        
        .search-section {
            padding: 1.5rem;
            background: linear-gradient(180deg, var(--earth-cream) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border);
        }
        
        .search-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
            position: relative;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .input-dot.start {
            background: var(--earth-forest);
        }
        
        .input-dot.end {
            background: var(--earth-terracotta);
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            gap: 0.5rem;
        }
        
        .input-field {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--earth-sage);
            box-shadow: 0 0 0 4px rgba(107, 142, 107, 0.15);
        }
        
        .input-field::placeholder {
            color: var(--earth-olive);
        }
        
        .btn-location {
            padding: 0 1rem;
            background: var(--earth-cream);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-location:hover {
            background: var(--earth-sand);
            border-color: var(--earth-sage);
        }
        
        .btn-location svg {
            width: 20px;
            height: 20px;
            color: var(--earth-forest);
        }
        
        .btn-search {
            width: 100%;
            padding: 1rem;
            background: var(--earth-terracotta);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-search:hover {
            background: var(--earth-clay);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-search:disabled {
            background: var(--earth-olive);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-search svg {
            width: 20px;
            height: 20px;
        }
        /* Autocomplete Dropdown */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--earth-sage);
            border-top: none;
            border-radius: 0 0 12px 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 10px;
        }

        .autocomplete-item:hover {
            background: var(--earth-cream);
        }

        .autocomplete-item.selected {
            background: var(--earth-cream);
        }

        .autocomplete-item-main {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .autocomplete-item-secondary {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .autocomplete-loading {
            padding: 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .autocomplete-no-results {
            padding: 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Adjust input when dropdown is open */
        .input-field.dropdown-open {
            border-radius: 12px 12px 0 0;
            border-color: var(--earth-sage);
        }
        
        /* Results Section */
        .results-section {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .results-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .results-count strong {
            color: var(--earth-forest);
            font-weight: 600;
        }
        
        /* Route Card */
        .route-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .route-card:hover {
            border-color: var(--earth-sage);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .route-card.selected {
            border-color: var(--earth-terracotta);
            box-shadow: 0 0 0 4px rgba(198, 123, 92, 0.15);
        }
        
        .route-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .route-buses {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .bus-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            background: var(--earth-forest);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .bus-badge svg {
            width: 16px;
            height: 16px;
        }
        
        .transfer-arrow {
            color: var(--earth-olive);
            font-size: 1.25rem;
        }
        
        .route-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .route-type.direct {
            background: rgba(61, 90, 61, 0.1);
            color: var(--earth-forest);
        }
        
        .route-type.transfer {
            background: rgba(198, 123, 92, 0.1);
            color: var(--earth-terracotta);
        }
        
        .route-stats {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Route Steps */
        .route-steps {
            display: none;
        }
        
        .route-card.expanded .route-steps {
            display: block;
        }
        
        .step {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            position: relative;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 11px;
            top: 32px;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .step-icon.walk {
            background: var(--earth-sand);
            color: var(--earth-brown);
        }
        
        .step-icon.bus {
            background: var(--earth-forest);
            color: white;
        }
        
        .step-icon svg {
            width: 14px;
            height: 14px;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .step-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--earth-sage);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
            transition: color 0.2s ease;
        }
        
        .expand-btn:hover {
            color: var(--earth-forest);
        }
        
        .expand-btn svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        
        .route-card.expanded .expand-btn svg {
            transform: rotate(180deg);
        }
        
        /* Loading State */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }
        
        .loading.visible {
            display: flex;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--earth-terracotta);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            color: var(--earth-olive);
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Error Message */
        .error-message {
            display: none;
            padding: 1rem;
            background: rgba(198, 123, 92, 0.1);
            border: 1px solid var(--earth-terracotta);
            border-radius: 12px;
            margin: 1rem;
            color: var(--earth-clay);
            font-size: 0.9rem;
        }
        
        .error-message.visible {
            display: block;
        }
        
        /* Right Panel - Map */
        .right-panel {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Custom Map Markers */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-start {
            width: 32px;
            height: 32px;
            background: var(--earth-forest);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        
        .marker-end {
            width: 32px;
            height: 32px;
            background: var(--earth-terracotta);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        
        .marker-stop {
            width: 16px;
            height: 16px;
            background: var(--earth-sage);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
         .marker-intermediate {
            width: 10px;
            height: 10px;
            background: #8FA889;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
        .marker-transfer {
            width: 24px;
            height: 24px;
            background: var(--earth-sand);
            border: 3px solid var(--earth-terracotta);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        
        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 500;
            font-size: 0.8rem;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.start { background: var(--earth-forest); }
        .legend-dot.end { background: var(--earth-terracotta); }
        .legend-dot.stop { background: var(--earth-sage); }
        .legend-dot.transfer { 
            background: var(--earth-sand); 
            border: 2px solid var(--earth-terracotta);
        }
        
        .legend-line {
            width: 24px;
            height: 3px;
            border-radius: 2px;
        }
        
        .legend-line.route { background: var(--earth-forest); }
        .legend-line.walk { 
            background: repeating-linear-gradient(
                90deg,
                var(--earth-terracotta) 0px,
                var(--earth-terracotta) 4px,
                transparent 4px,
                transparent 8px
            );
        }
        
        /* Mobile Responsive */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column-reverse;
            }
            
            .left-panel {
                width: 100%;
                min-width: auto;
                height: 50vh;
                border-right: none;
                border-top: 1px solid var(--border);
            }
            
            .right-panel {
                height: 50vh;
            }
            
            .map-legend {
                bottom: 12px;
                right: 12px;
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 500px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .brand-name {
                font-size: 1.4rem;
            }
            
            .brand-tagline {
                display: none;
            }
            
            .search-section {
                padding: 1rem;
            }
            
            .sort-section {
                padding: 0.5rem 1rem;
                flex-wrap: wrap;
            }
            
            .route-stats {
                gap: 1rem;
                flex-wrap: wrap;
            }
            
            .left-panel {
                height: 60vh;
            }
            
            .right-panel {
                height: 40vh;
            }
        }
        .disclaimer-text {
            margin-top: 1.5rem;
            padding: 0.6rem 1rem;
            background: rgba(198, 123, 92, 0.1);
            border: 1px solid rgba(198, 123, 92, 0.3);
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--earth-brown);
            max-width: 300px;
        }
        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
        }
        
        .leaflet-popup-content {
            margin: 12px 16px;
        }
        
        .popup-title {
            font-weight: 600;
            color: var(--earth-dark);
            margin-bottom: 4px;
        }
        
        .popup-detail {
            font-size: 0.85rem;
            color: var(--earth-brown);
        }
        
        /* Scrollbar Styling */
        .results-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .results-section::-webkit-scrollbar-track {
            background: var(--earth-cream);
        }
        
        .results-section::-webkit-scrollbar-thumb {
            background: var(--earth-olive);
            border-radius: 4px;
        }
        
        .results-section::-webkit-scrollbar-thumb:hover {
            background: var(--earth-sage);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <div>
                <div class="brand-name">Tuni<span>Kar</span><small style="font-size: 0.5em; font-weight: 300; color: var(--earth-olive);">- Guide des trajets en bus du Grand Tunis</small> </div>
            </div>
        </div>
        <div class="brand-tagline">Transport Grand Tunis</div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel -->
        <aside class="left-panel">
            <!-- Search Section -->
            <div class="search-section">
                <h2 class="search-title">Trouvez les bus</h2>
                
                <div class="input-group">
                    <label class="input-label">
                        <span class="input-dot start"></span>
                        Point de départ
                    </label>
                    <div class="input-wrapper">
                        <div class="autocomplete-wrapper" style="flex: 1;">
                            <input type="text" id="start-input" class="input-field" placeholder="Entrez une adresse ou cliquez sur la carte" autocomplete="off">
                            <div class="autocomplete-dropdown" id="start-autocomplete"></div>
                        </div>
                        <button class="btn-location" id="btn-gps-start" title="Utiliser ma Localisation">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        <span class="input-dot end"></span>
                        Destination
                    </label>
                    <div class="input-wrapper">
                        <div class="autocomplete-wrapper" style="flex: 1;">
                            <input type="text" id="end-input" class="input-field" placeholder="Entrez une adresse ou cliquez sur la carte" autocomplete="off">
                            <div class="autocomplete-dropdown" id="end-autocomplete"></div>
                        </div>
                        <button class="btn-location" id="btn-gps-end" title="Utiliser ma localisation">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <button class="btn-search" id="btn-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14m-7-7 7 7-7 7"></path>
                    </svg>
                    Rechercher
                </button>
            </div>
            <!-- Error Message -->
            <div class="error-message" id="error-message"></div>
            
            <!-- Results Section -->
            <div class="results-section" id="results-section">
                <!-- Loading State -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Recherche des meilleurs itinéraires...</p>
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <h3>Planifiez Votre Trajet</h3>
                    <p>Entrez votre départ et destination pour trouver les lignes de bus disponibles</p>
                     <div class="disclaimer-text">
                        ⚠️ Projet étudiant - Les informations peuvent contenir des erreurs.
                    </div>
                </div>
                
                <!-- Results Container -->
                <div id="results-container"></div>
            </div>
        </aside>
        
        <!-- Right Panel - Map -->
        <div class="right-panel">
            <div id="map"></div>
            <div class="map-legend">
                <div class="legend-title">Légende</div>
                <div class="legend-item">
                    <span class="legend-dot start"></span>
                    <span>Point de Départ</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot end"></span>
                    <span>Destination</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot stop"></span>
                    <span>Station</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot transfer"></span>
                    <span>Point de changement</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line route"></span>
                    <span>Ligne de Bus</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line walk"></span>
                    <span>Marche à Pied</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================================
        // TuniKar - Route Finder Application
        // ============================================================
        
        const API_BASE = '';  // Same origin
        
        // State
        let map;
        let startCoords = null;
        let endCoords = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayers = [];
        let allRoutes = [];
        let selectedRouteIndex = -1;
        let clickMode = null; // 'start' or 'end'
        
        // Greater Tunis bounds
        const TUNIS_CENTER = [36.8065, 10.1815];
        const TUNIS_BOUNDS = [[36.4, 9.5], [37.1, 10.6]];
        
        // ============================================================
        // Initialize Map
        // ============================================================
        
        function initMap() {
            map = L.map('map', {
                center: TUNIS_CENTER,
                zoom: 11,
                minZoom: 9,
                maxZoom: 18,
                maxBounds: TUNIS_BOUNDS,
                maxBoundsViscosity: 1.0
            });
            
            // Add OpenStreetMap tiles with earthy style
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Click handler for setting start/end
            map.on('click', handleMapClick);
            
            // Add instructions popup
            showMapInstructions();
        }
        
        function showMapInstructions() {
            const popup = L.popup()
                .setLatLng(TUNIS_CENTER)
                .setContent(`
                    <div class="popup-title">Bienvenue sur TuniKar</div>
                    <div class="popup-detail">Cliquez sur la carte pour définir vos points de départ et d'arrivée, ou utilisez les champs de recherche.</div>
                `)
                .openOn(map);
            
            setTimeout(() => map.closePopup(), 10000);
        }
        
        // ============================================================
        // Custom Markers
        // ============================================================
        
        function createMarkerIcon(type) {
            const colors = {
                start: '#3D5A3D',
                end: '#C67B5C',
                stop: '#6B8E6B',
                transfer: '#D4C4A8',
                intermediate: '#8FA889' 
            };
            
            const color = colors[type];
            
            // Use SVG location pin for start and end
            if (type === 'start' || type === 'end') {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<svg width="30" height="40" viewBox="0 0 24 32" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                        <path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20c0-6.6-5.4-12-12-12zm0 16c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z" fill="${color}"/>
                        <circle cx="12" cy="12" r="4" fill="white"/>
                    </svg>`,
                    iconSize: [30, 40],
                    iconAnchor: [15, 40]  // Anchor at bottom center of pin
                });
            } else if (type === 'transfer') {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 20px;
                        height: 20px;
                        background: ${color};
                        border: 3px solid #C67B5C;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                    "></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
            } else if (type === 'stop') {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 12px;
                        height: 12px;
                        background: ${color};
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    "></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });
            } else {
                // intermediate stops - small dots
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 8px;
                        height: 8px;
                        background: ${color};
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    "></div>`,
                    iconSize: [8, 8],
                    iconAnchor: [4, 4]
                });
            }
        }
        
        // ============================================================
        // Map Click Handler
        // ============================================================
        
        function handleMapClick(e) {
            const { lat, lng } = e.latlng;
            
            if (!startCoords) {
                setStartLocation(lat, lng);
                reverseGeocode(lat, lng, 'start');
            } else if (!endCoords) {
                setEndLocation(lat, lng);
                reverseGeocode(lat, lng, 'end');
            } else {
                // Both set, update the one that was clicked more recently based on proximity
                const distToStart = map.distance(e.latlng, L.latLng(startCoords));
                const distToEnd = map.distance(e.latlng, L.latLng(endCoords));
                
                if (distToStart < distToEnd) {
                    setStartLocation(lat, lng);
                    reverseGeocode(lat, lng, 'start');
                } else {
                    setEndLocation(lat, lng);
                    reverseGeocode(lat, lng, 'end');
                }
            }
        }
        
        function setStartLocation(lat, lng) {
            startCoords = [lat, lng];
            
            if (startMarker) {
                map.removeLayer(startMarker);
            }
            
            startMarker = L.marker([lat, lng], {
                icon: createMarkerIcon('start'),
                draggable: true
            }).addTo(map);
            
            startMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                startCoords = [pos.lat, pos.lng];
                reverseGeocode(pos.lat, pos.lng, 'start');
            });
            
            startMarker.bindPopup('<div class="popup-title">Point de Départ</div>');
        }
        
        function setEndLocation(lat, lng) {
            endCoords = [lat, lng];
            
            if (endMarker) {
                map.removeLayer(endMarker);
            }
            
            endMarker = L.marker([lat, lng], {
                icon: createMarkerIcon('end'),
                draggable: true
            }).addTo(map);
            
            endMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                endCoords = [pos.lat, pos.lng];
                reverseGeocode(pos.lat, pos.lng, 'end');
            });
            
            endMarker.bindPopup('<div class="popup-title">Destination</div>');
        }
        // ============================================================
        // Autocomplete / Typeahead
        // ============================================================

        const autocompleteConfig = {
            minChars: 2,
            debounceMs: 300,
            maxResults: 7
        };

        let autocompleteTimers = {
            start: null,
            end: null
        };

        let selectedAutocompleteIndex = {
            start: -1,
            end: -1
        };
        const commonPlaces = {
            'lac': 'Les Berges du Lac Tunis',
            'lac 1': 'Les Berges du Lac Tunis',
            'lac 2': 'Les Berges du Lac 2 Tunis',
            'lac2': 'Les Berges du Lac 2 Tunis',
            'bardo': 'Le Bardo Tunis',
            'marsa': 'La Marsa Tunis',
            'carthage': 'Carthage Tunis',
            'ariana': 'Ariana Tunisie',
            'menzah': 'El Menzah Tunis',
            'manar': 'El Manar Tunis',
            'centre ville': 'Centre Ville Tunis',
            'habib bourguiba': 'Avenue Habib Bourguiba Tunis'
        };

        async function searchPlaces(query) {
            if (!query || query.length < autocompleteConfig.minChars) {
                return [];
            }
            
            try {
                // Check if query matches a common place
                const queryLower = query.toLowerCase().trim();
                const mappedQuery = commonPlaces[queryLower] || query;
                
                const params = new URLSearchParams({
                    q: mappedQuery,
                    format: 'json',
                    limit: autocompleteConfig.maxResults,
                    countrycodes: 'tn',
                    addressdetails: 1,
                    dedupe: 1
                });
                
                let response = await fetch(
                    `https://nominatim.openstreetmap.org/search?${params}`,
                    { 
                        headers: { 
                            'User-Agent': 'TuniKarApp/1.0',
                            'Accept-Language': 'fr,ar,en'
                        }
                    }
                );
                
                if (!response.ok) return [];
                
                let data = await response.json();
                
                // If no results or few results, try with "Tunis" appended
                if (data.length < 2) {
                    const params2 = new URLSearchParams({
                        q: `${query} Tunis`,
                        format: 'json',
                        limit: autocompleteConfig.maxResults,
                        countrycodes: 'tn',
                        addressdetails: 1,
                        dedupe: 1
                    });
                    
                    const response2 = await fetch(
                        `https://nominatim.openstreetmap.org/search?${params2}`,
                        { 
                            headers: { 
                                'User-Agent': 'TuniKarApp/1.0',
                                'Accept-Language': 'fr,ar,en'
                            }
                        }
                    );
                    
                    if (response2.ok) {
                        const data2 = await response2.json();
                        // Combine results, removing duplicates
                        const existingIds = new Set(data.map(p => p.place_id));
                        data2.forEach(place => {
                            if (!existingIds.has(place.place_id)) {
                                data.push(place);
                            }
                        });
                    }
                }
                
                // If still no results, try with "Berges du Lac" for "lac" queries
                if (data.length === 0 && query.toLowerCase().includes('lac')) {
                    const params3 = new URLSearchParams({
                        q: 'Berges du Lac Tunis',
                        format: 'json',
                        limit: autocompleteConfig.maxResults,
                        countrycodes: 'tn',
                        addressdetails: 1
                    });
                    
                    const response3 = await fetch(
                        `https://nominatim.openstreetmap.org/search?${params3}`,
                        { 
                            headers: { 
                                'User-Agent': 'TuniKarApp/1.0',
                                'Accept-Language': 'fr,ar,en'
                            }
                        }
                    );
                    
                    if (response3.ok) {
                        data = await response3.json();
                    }
                }
                
                // Prioritize results in Greater Tunis area
                const sortedData = data.sort((a, b) => {
                    const aInTunis = isInGreaterTunis(parseFloat(a.lat), parseFloat(a.lon));
                    const bInTunis = isInGreaterTunis(parseFloat(b.lat), parseFloat(b.lon));
                    if (aInTunis && !bInTunis) return -1;
                    if (!aInTunis && bInTunis) return 1;
                    return 0;
                });
                
                return sortedData.slice(0, autocompleteConfig.maxResults).map(place => ({
                    name: formatPlaceName(place),
                    fullName: place.display_name,
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    type: place.type,
                    category: place.class
                }));
                
            } catch (error) {
                console.error('Erreur de recherche:', error);
                return [];
            }
        }

        function isInGreaterTunis(lat, lon) {
            // Greater Tunis bounding box
            return lat >= 36.4 && lat <= 37.1 && lon >= 9.5 && lon <= 10.6;
        }

        function formatPlaceName(place) {
             //Format place name for display
            const address = place.address || {};
            
            // Try to get a nice short name
            const name = place.name || 
                        address.amenity || 
                        address.building ||
                        address.road ||
                        address.neighbourhood ||
                        place.display_name.split(',')[0];
            
            return name;
        }

        function formatSecondaryInfo(place) {
             //Format secondary info (area/city)
            const parts = place.fullName.split(',');
            if (parts.length > 2) {
                // Get 2nd and 3rd parts (usually neighborhood and city)
                return parts.slice(1, 3).join(',').trim();
            }
            return parts.slice(1).join(',').trim();
        }

        function showAutocomplete(type, results) {
            const dropdown = document.getElementById(`${type}-autocomplete`);
            const input = document.getElementById(`${type}-input`);
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">Aucun lieu trouvé</div>';
                dropdown.classList.add('visible');
                input.classList.add('dropdown-open');
                return;
            }
            
            dropdown.innerHTML = results.map((place, index) => `
                <div class="autocomplete-item" data-index="${index}" data-lat="${place.lat}" data-lon="${place.lon}" data-name="${place.fullName}">
                    <div class="autocomplete-item-main">${place.name}</div>
                    <div class="autocomplete-item-secondary">${formatSecondaryInfo(place)}</div>
                </div>
            `).join('');
            
            // Add click handlers
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent blur from firing
                    selectAutocompleteItem(type, item);
                });
            });
            
            dropdown.classList.add('visible');
            input.classList.add('dropdown-open');
            selectedAutocompleteIndex[type] = -1;
        }

        function hideAutocomplete(type) {
            const dropdown = document.getElementById(`${type}-autocomplete`);
            const input = document.getElementById(`${type}-input`);
            
            dropdown.classList.remove('visible');
            input.classList.remove('dropdown-open');
            selectedAutocompleteIndex[type] = -1;
        }

        function selectAutocompleteItem(type, item) {
            const lat = parseFloat(item.dataset.lat);
            const lon = parseFloat(item.dataset.lon);
            const name = item.dataset.name;
            
            // Update input
            const input = document.getElementById(`${type}-input`);
            input.value = name.split(',').slice(0, 3).join(',');
            
            // Set location on map
            if (type === 'start') {
                setStartLocation(lat, lon);
            } else {
                setEndLocation(lat, lon);
            }
            
            // Center map on selected location
            map.setView([lat, lon], 15);
            
            // Hide dropdown
            hideAutocomplete(type);
        }

        function handleAutocompleteKeydown(type, event) {
            const dropdown = document.getElementById(`${type}-autocomplete`);
            const items = dropdown.querySelectorAll('.autocomplete-item');
            
            if (!dropdown.classList.contains('visible') || items.length === 0) {
                return;
            }
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedAutocompleteIndex[type] = Math.min(
                        selectedAutocompleteIndex[type] + 1, 
                        items.length - 1
                    );
                    updateAutocompleteSelection(type, items);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedAutocompleteIndex[type] = Math.max(
                        selectedAutocompleteIndex[type] - 1, 
                        0
                    );
                    updateAutocompleteSelection(type, items);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (selectedAutocompleteIndex[type] >= 0) {
                        selectAutocompleteItem(type, items[selectedAutocompleteIndex[type]]);
                    } else if (items.length > 0) {
                        selectAutocompleteItem(type, items[0]);
                    }
                    break;
                    
                case 'Escape':
                    hideAutocomplete(type);
                    break;
            }
        }

        function updateAutocompleteSelection(type, items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedAutocompleteIndex[type]);
            });
            
            // Scroll selected item into view
            if (selectedAutocompleteIndex[type] >= 0) {
                items[selectedAutocompleteIndex[type]].scrollIntoView({
                    block: 'nearest'
                });
            }
        }

        function setupAutocomplete(type) {
            const input = document.getElementById(`${type}-input`);
            
            // Input event - trigger search with debounce
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timer
                if (autocompleteTimers[type]) {
                    clearTimeout(autocompleteTimers[type]);
                }
                
                // Clear coordinates since user is typing new address
                if (type === 'start') {
                    startCoords = null;
                    if (startMarker) {
                        map.removeLayer(startMarker);
                        startMarker = null;
                    }
                } else {
                    endCoords = null;
                    if (endMarker) {
                        map.removeLayer(endMarker);
                        endMarker = null;
                    }
                }
                
                // Hide dropdown if query too short
                if (query.length < autocompleteConfig.minChars) {
                    hideAutocomplete(type);
                    return;
                }
                
                // Show loading state
                const dropdown = document.getElementById(`${type}-autocomplete`);
                dropdown.innerHTML = '<div class="autocomplete-loading">Recherche en cours...</div>';
                dropdown.classList.add('visible');
                input.classList.add('dropdown-open');
                
                // Debounced search
                autocompleteTimers[type] = setTimeout(async () => {
                    const results = await searchPlaces(query);
                    showAutocomplete(type, results);
                }, autocompleteConfig.debounceMs);
            });
            
            // Keyboard navigation
            input.addEventListener('keydown', (e) => {
                handleAutocompleteKeydown(type, e);
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const wrapper = input.closest('.autocomplete-wrapper');
                if (!wrapper.contains(e.target)) {
                    hideAutocomplete(type);
                }
            });
            
            // Hide dropdown on blur (with small delay to allow click on item)
            input.addEventListener('blur', () => {
                setTimeout(() => hideAutocomplete(type), 300);
            });
            
            // Show dropdown on focus if there's text
            input.addEventListener('focus', async () => {
                const query = input.value.trim();
                if (query.length >= autocompleteConfig.minChars) {
                    const results = await searchPlaces(query);
                    showAutocomplete(type, results);
                }
            });
        }
        // ============================================================
        // Geocoding
        // ============================================================
        
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`${API_BASE}/api/geocode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return {
                        lat: data.coordinates.latitude,
                        lng: data.coordinates.longitude,
                        display: data.display_name
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }
        
        async function reverseGeocode(lat, lng, type) {
            // Use Nominatim for reverse geocoding
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`,
                    { headers: { 'User-Agent': 'TuniKarApp/1.0' } }
                );
                const data = await response.json();
                
                if (data.display_name) {
                    const shortName = data.display_name.split(',').slice(0, 3).join(',');
                    document.getElementById(`${type}-input`).value = shortName;
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
            }
        }
        
        // ============================================================
        // GPS Location
        // ============================================================
        
        function getCurrentLocation(type) {
    if (!navigator.geolocation) {
        showError('La géolocalisation n\'est pas supportée par votre navigateur');
        return;
    }
    
    // Show user we're trying to get location
    const btn = document.getElementById('btn-gps-' + type);
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner"><circle cx="12" cy="12" r="10"></circle></svg>';
    btn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        // SUCCESS
        (position) => {
            const { latitude, longitude } = position.coords;
            
            if (type === 'start') {
                setStartLocation(latitude, longitude);
                reverseGeocode(latitude, longitude, 'start');
            } else {
                setEndLocation(latitude, longitude);
                reverseGeocode(latitude, longitude, 'end');
            }
            
            map.setView([latitude, longitude], 15);
            
            // Restore button
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            hideError();
        },
        // ERROR
        (error) => {
            // Restore button
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            
            // Handle different error types
            let errorMessage = 'Impossible d\'obtenir votre position. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Vous avez refusé l\'accès à la localisation. Veuillez activer les permissions dans les paramètres de votre navigateur.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Les informations de localisation ne sont pas disponibles. Veuillez réessayer.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'La demande de localisation a expiré. Veuillez réessayer.';
                    break;
                default:
                    errorMessage += 'Veuillez entrer une adresse manuellement ou cliquer sur la carte.';
            }
            
            showError(errorMessage);
            console.error('Geolocation error:', error);
        },
        // OPTIONS
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}
        
        // ============================================================
        // Route Search
        // ============================================================
        
        async function searchRoutes() {
            // Get coordinates from inputs if not set by map
            const startInput = document.getElementById('start-input').value.trim();
            const endInput = document.getElementById('end-input').value.trim();
            
            // Validate inputs
            if (!startInput && !startCoords) {
                showError('Veuillez entrer un point de départ ou cliquer sur la carte');
                return;
            }
            
            if (!endInput && !endCoords) {
                showError('Veuillez entrer une destination  ou cliquer sur la carte');
                return;
            }
            
            // Show loading
            showLoading(true);
            hideError();
            clearRoutes();
            
            try {
                // Geocode if needed
                if (startInput && !startCoords) {
                    const result = await geocodeAddress(startInput);
                    if (result) {
                        setStartLocation(result.lat, result.lng);
                    } else {
                        showError('Impossible de trouver l\'adresse de départ');
                        showLoading(false);
                        return;
                    }
                }
                
                if (endInput && !endCoords) {
                    const result = await geocodeAddress(endInput);
                    if (result) {
                        setEndLocation(result.lat, result.lng);
                    } else {
                        showError('Impossible de trouver l\'adresse de destination');
                        showLoading(false);
                        return;
                    }
                }
                
                // Fetch both direct and transfer routes
                const [directRoutes, transferRoutes] = await Promise.all([
                    fetchDirectRoutes(),
                    fetchTransferRoutes()
                ]);
                
                // Combine and process routes
                allRoutes = [
                    ...directRoutes.map(r => ({ ...r, routeType: 'direct', transfers: 0 })),
                    ...transferRoutes.map(r => ({ ...r, routeType: 'transfer', transfers: 1 }))
                ];
                
                if (allRoutes.length === 0) {
                    showEmptyResults("Aucun itinéraire de bus trouvé dans un rayon de 500m. Essayez d'autres adresses ou rapprochez vos points de départ/arrivée des arrêts de bus.");
                } else {
                    sortAndDisplayRoutes();
                    fitMapToRoute();
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showError('Une erreur s\'est produite lors de la recherche. Veuillez réessayer.');
            }
            
            showLoading(false);
        }
        
        async function fetchDirectRoutes() {
            try {
                const response = await fetch(`${API_BASE}/api/routes/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: { latitude: startCoords[0], longitude: startCoords[1] },
                        end: { latitude: endCoords[0], longitude: endCoords[1] }
                    })
                });
                
                const data = await response.json();
                return data.success ? (data.valid_routes_only || []) : [];
            } catch (error) {
                console.error('Direct routes error:', error);
                return [];
            }
        }
        
        async function fetchTransferRoutes() {
            try {
                const response = await fetch(`${API_BASE}/api/routes/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: { latitude: startCoords[0], longitude: startCoords[1] },
                        end: { latitude: endCoords[0], longitude: endCoords[1] },
                        max_results: 10
                    })
                });
                
                const data = await response.json();
                return data.success ? (data.routes || []) : [];
            } catch (error) {
                console.error('Transfer routes error:', error);
                return [];
            }
        }
        
        // ============================================================
        // Display Routes
        // ============================================================
        
        function sortAndDisplayRoutes() {
            // Always sort by fastest (time)
            const sorted = [...allRoutes].sort((a, b) => {
                return getTotalTime(a) - getTotalTime(b);
            });
            
            displayRoutes(sorted);
        }
        
        function getTotalTime(route) {
            if (route.routeType === 'direct') {
                return route.total_time_minutes || 0;
            }
            return route.total_time_minutes || 0;
        }
        
        function getTotalWalking(route) {
            if (route.routeType === 'direct') {
                return (route.walking?.to_start_meters || 0) + (route.walking?.from_end_meters || 0);
            }
            return route.summary?.total_walking_meters || 0;
        }
        
        function displayRoutes(routes) {
            const container = document.getElementById('results-container');
            document.getElementById('empty-state').style.display = 'none';
            
            container.innerHTML = `
                <div class="results-header">
                    <span class="results-count"><strong>${routes.length}</strong> itinéraires trouvés</span>
                </div>
                ${routes.map((route, index) => createRouteCard(route, index)).join('')}
            `;
            
            // Add click handlers
            container.querySelectorAll('.route-card').forEach((card, index) => {
                card.addEventListener('click', () => selectRoute(index));
            });
            
            container.querySelectorAll('.expand-btn').forEach((btn, index) => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleRouteExpand(index);
                });
            });
        }
        
        function createRouteCard(route, index) {
            const isTransfer = route.routeType === 'transfer';
            const time = getTotalTime(route);
            const walking = getTotalWalking(route);
            const stops = isTransfer ? route.summary?.total_bus_stops : route.validation?.stops_count;
            
            // Get bus info
            let busesHtml = '';
            if (isTransfer) {
                const buses = route.summary?.buses_used || [];
                busesHtml = buses.map((bus, i) => `
                    <span class="bus-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 6v6m8-6v6M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
                            <circle cx="7" cy="18" r="2"></circle>
                            <circle cx="17" cy="18" r="2"></circle>
                        </svg>
                        ${bus}
                    </span>
                    ${i < buses.length - 1 ? '<span class="transfer-arrow">→</span>' : ''}
                `).join('');
            } else {
                busesHtml = `
                    <span class="bus-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 6v6m8-6v6M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
                            <circle cx="7" cy="18" r="2"></circle>
                            <circle cx="17" cy="18" r="2"></circle>
                        </svg>
                        ${route.bus_line}
                    </span>
                `;
            }
            
            // Create steps HTML
            const stepsHtml = createStepsHtml(route);
            
            return `
                <div class="route-card" data-index="${index}">
                    <div class="route-header">
                        <div class="route-buses">${busesHtml}</div>
                        <span class="route-type ${route.routeType}">${isTransfer ? '1 Transfert' : 'Direct'}</span>
                    </div>
                    
                    <div class="route-stats">
                        <div class="stat">
                            <span class="stat-value">${time} min</span>
                            <span class="stat-label">Durée Totale</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${Math.round(walking)} m</span>
                            <span class="stat-label">Marche</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${stops || '-'}</span>
                            <span class="stat-label">Station bus</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${route.transfers}</span>
                            <span class="stat-label">changements de bus</span>
                        </div>
                    </div>
                    
                    <div class="route-steps">
                        ${stepsHtml}
                    </div>
                    
                    <button class="expand-btn">
                        <span>Voir Détails</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"></path>
                        </svg>
                    </button>
                </div>
            `;
        }
        
        function createStepsHtml(route) {
            if (route.routeType === 'transfer' && route.segments) {
                return route.segments.map(seg => {
                    if (seg.type === 'walk') {
                        let walkInstruction = seg.instruction;
                        if (walkInstruction.includes('Walk to') && walkInstruction.includes('for transfer')) {
                            const stopName = walkInstruction.replace('Walk to ', '').replace(' for transfer', '');
                            walkInstruction = `Marcher vers ${stopName} pour le changement`;
                        } else if (walkInstruction.includes('Walk to')) {
                            const stopName = walkInstruction.replace('Walk to ', '');
                            walkInstruction = `Marcher vers ${stopName}`;
                        } else if (walkInstruction === 'Walk to destination') {
                            walkInstruction = 'Marcher vers la destination';
                        }
                        
                        return `
                            <div class="step">
                                <div class="step-icon walk">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M13 4v4l3 3m-6 0l-3 3v6m8-6l3 3v4M9 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                    </svg>
                                </div>
                                <div class="step-content">
                                    <div class="step-title">${walkInstruction}</div>
                                    <div class="step-detail">${seg.distance_meters}m · ${seg.duration_minutes} min</div>
                                </div>
                            </div>
                        `;
                    } else if (seg.type === 'bus') {
                        // Translate bus instruction to French
                        let busInstruction = seg.instruction;
                        if (busInstruction.includes('Take Bus')) {
                            busInstruction = busInstruction.replace('Take Bus', 'Prendre Bus');
                        }
                        
                        return `
                            <div class="step">
                                <div class="step-icon bus">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M8 6v6m8-6v6M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
                                    </svg>
                                </div>
                                <div class="step-content">
                                    <div class="step-title">${busInstruction}</div>
                                    <div class="step-detail">
                                        ${seg.board_at?.name} → ${seg.alight_at?.name}<br>
                                        ${seg.stops_count} arrêts · ${seg.duration_minutes} min
                                    </div>
                                </div>
                            </div>
                        `;
                    }
            
                    return '';
                }).join('');
            } else {
                // Direct route - keep your existing code here
                return `
                    <div class="step">
                        <div class="step-icon walk">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 4v4l3 3m-6 0l-3 3v6m8-6l3 3v4M9 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Marcher vers ${route.start_stop?.name}</div>
                            <div class="step-detail">${route.walking?.to_start_meters}m · ${route.walking?.to_start_minutes} min</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-icon bus">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 6v6m8-6v6M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Bus ${route.bus_line} (${route.direction})</div>
                            <div class="step-detail">
                                ${route.start_stop?.name} → ${route.end_stop?.name}<br>
                                ${route.validation?.stops_count} stops · ${route.validation?.estimated_minutes} min
                            </div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-icon walk">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 4v4l3 3m-6 0l-3 3v6m8-6l3 3v4M9 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Marcher vers la destination</div>
                            <div class="step-detail">${route.walking?.from_end_meters}m · ${route.walking?.from_end_minutes} min</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleRouteExpand(index) {
            const card = document.querySelector(`.route-card[data-index="${index}"]`);
            card.classList.toggle('expanded');
            
            const btn = card.querySelector('.expand-btn span');
            btn.textContent = card.classList.contains('expanded') ? 'Masquer Détails' : 'Voir Détails';
        }
        
        async function selectRoute(index) {
            // Update selection state
            document.querySelectorAll('.route-card').forEach((card, i) => {
                if (i === index) {
                            card.classList.add('selected');
                            card.classList.add('expanded');  // Auto-expand selected route
                            // Update button text
                            const btn = card.querySelector('.expand-btn span');
                            if (btn) btn.textContent = 'Masquer Détails';
                        } else {
                            card.classList.remove('selected');
                            card.classList.remove('expanded');  // Collapse other routes
                            // Reset button text
                            const btn = card.querySelector('.expand-btn span');
                            if (btn) btn.textContent = 'Voir Détails';
                        }
                    });
            
             selectedRouteIndex = index;
            await displayRouteOnMap(allRoutes[index]);
        }
        
        // ============================================================
        // Map Route Display
        // ============================================================
        
        function clearRoutes() {
            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];
        }
            // ============================================================
            // Walking Path Fetching (OSRM)
            // ============================================================

        async function fetchWalkingPath(startLat, startLon, endLat, endLon) {
            try {
                const response = await fetch(`${API_BASE}/api/routes/walking-path`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_lat: startLat,
                        start_lon: startLon,
                        end_lat: endLat,
                        end_lon: endLon
                    })
                });
                const data = await response.json();
                if (data.success && data.path) {
                    return data.path;
                }
                return null;
            } catch (error) {
                console.error('Walking path fetch error:', error);
                return null;
            }
        }
        async function displayRouteOnMap(route) {
            clearRoutes();
            
            if (route.routeType === 'transfer' && route.segments) {
                // Transfer route with multiple segments
                for (let index = 0; index < route.segments.length; index++) {
                    const seg = route.segments[index];
                    
                    if (seg.type === 'walk') {
                        let path = seg.path;
                        
                        // Fetch OSRM path if not already loaded
                        if (!path || path.length === 0) {
                            let walkStart, walkEnd;
                            
                            if (index === 0) {
                                // Walk from user start to first bus stop
                                walkStart = startCoords;
                                walkEnd = seg.details?.coordinates ? 
                                    [seg.details.coordinates.latitude, seg.details.coordinates.longitude] : null;
                            } else if (index === route.segments.length - 1) {
                                // Walk from last bus stop to destination
                                const prevSeg = route.segments[index - 1];
                                walkStart = prevSeg.alight_at?.coordinates ? 
                                    [prevSeg.alight_at.coordinates.latitude, prevSeg.alight_at.coordinates.longitude] : null;
                                walkEnd = endCoords;
                            } else {
                                // Transfer walk between buses
                                const prevSeg = route.segments[index - 1];
                                const nextSeg = route.segments[index + 1];
                                walkStart = prevSeg.alight_at?.coordinates ? 
                                    [prevSeg.alight_at.coordinates.latitude, prevSeg.alight_at.coordinates.longitude] : null;
                                walkEnd = nextSeg.board_at?.coordinates ? 
                                    [nextSeg.board_at.coordinates.latitude, nextSeg.board_at.coordinates.longitude] : null;
                            }
                            
                            // Fetch realistic path from OSRM
                            if (walkStart && walkEnd) {
                                path = await fetchWalkingPath(walkStart[0], walkStart[1], walkEnd[0], walkEnd[1]);
                                // Cache the path for future use
                                seg.path = path;
                            }
                        }
                        
                        // Draw the path
                        if (path && path.length > 0) {
                            const walkLine = L.polyline(path, {
                                color: '#C67B5C',
                                weight: 4,
                                dashArray: '8, 8',
                                opacity: 0.8
                            }).addTo(map);
                            routeLayers.push(walkLine);
                        } else if (seg.details?.coordinates) {
                            // Fallback to straight line
                            let walkStart, walkEnd;
                            if (index === 0) {
                                walkStart = startCoords;
                                walkEnd = [seg.details.coordinates.latitude, seg.details.coordinates.longitude];
                            } else if (index === route.segments.length - 1) {
                                const prevSeg = route.segments[index - 1];
                                walkStart = [prevSeg.alight_at.coordinates.latitude, prevSeg.alight_at.coordinates.longitude];
                                walkEnd = endCoords;
                            }
                            
                            if (walkStart && walkEnd) {
                                const walkLine = L.polyline([walkStart, walkEnd], {
                                    color: '#C67B5C',
                                    weight: 4,
                                    dashArray: '8, 8',
                                    opacity: 0.8
                                }).addTo(map);
                                routeLayers.push(walkLine);
                            }
                        }
                    } else if (seg.type === 'bus') {
                        // Bus route - draw through ALL intermediate stops
                        if (seg.intermediate_stops && seg.intermediate_stops.length > 0) {
                            const pathCoords = seg.intermediate_stops.map(stop => 
                                [stop.coordinates.latitude, stop.coordinates.longitude]
                            );
                            
                            const busLine = L.polyline(pathCoords, {
                                color: '#3D5A3D',
                                weight: 5,
                                opacity: 0.9
                            }).addTo(map);
                            routeLayers.push(busLine);
                            
                            // Add markers for each intermediate stop
                            seg.intermediate_stops.forEach((stop, stopIndex) => {
                                const isFirst = stopIndex === 0;
                                const isLast = stopIndex === seg.intermediate_stops.length - 1;
                                
                                let markerType = 'intermediate';
                                if (isFirst) markerType = 'stop';
                                if (isLast) markerType = 'stop';
                                
                                const marker = L.marker(
                                    [stop.coordinates.latitude, stop.coordinates.longitude],
                                    { icon: createMarkerIcon(markerType) }
                                ).addTo(map);
                                
                                let popupText = `<div class="popup-title">${stop.name}</div>`;
                                if (isFirst) {
                                    popupText += `<div class="popup-detail">Monter Bus${seg.bus_line}</div>`;
                                } else if (isLast) {
                                    popupText += `<div class="popup-detail">Descendre Bus ${seg.bus_line}</div>`;
                                } else {
                                    popupText += `<div class="popup-detail">Station #${stop.number}</div>`;
                                }
                                marker.bindPopup(popupText);
                                routeLayers.push(marker);
                            });
                        }
                    }
                }
            } else {
                // Direct route
                if (route.start_stop?.coordinates && route.end_stop?.coordinates) {
                    // Walking to start - fetch OSRM path
                    let walkToStartPath = route.walking?.to_start_path;
                    if (!walkToStartPath || walkToStartPath.length === 0) {
                        walkToStartPath = await fetchWalkingPath(
                            startCoords[0], startCoords[1],
                            route.start_stop.coordinates.latitude, route.start_stop.coordinates.longitude
                        );
                        // Cache it
                        if (route.walking) route.walking.to_start_path = walkToStartPath;
                    }
                    
                    if (walkToStartPath && walkToStartPath.length > 0) {
                        const walkToStart = L.polyline(walkToStartPath, {
                            color: '#C67B5C',
                            weight: 4,
                            dashArray: '8, 8',
                            opacity: 0.8
                        }).addTo(map);
                        routeLayers.push(walkToStart);
                    } else {
                        // Fallback straight line
                        const walkToStart = L.polyline([
                            startCoords,
                            [route.start_stop.coordinates.latitude, route.start_stop.coordinates.longitude]
                        ], {
                            color: '#C67B5C',
                            weight: 4,
                            dashArray: '8, 8',
                            opacity: 0.8
                        }).addTo(map);
                        routeLayers.push(walkToStart);
                    }
                    
                    // Bus route - through ALL intermediate stops
                    if (route.intermediate_stops && route.intermediate_stops.length > 0) {
                        const pathCoords = route.intermediate_stops.map(stop => 
                            [stop.coordinates.latitude, stop.coordinates.longitude]
                        );
                        
                        const busLine = L.polyline(pathCoords, {
                            color: '#3D5A3D',
                            weight: 5,
                            opacity: 0.9
                        }).addTo(map);
                        routeLayers.push(busLine);
                        
                        // Add markers for each stop
                        route.intermediate_stops.forEach((stop, index) => {
                            const isFirst = index === 0;
                            const isLast = index === route.intermediate_stops.length - 1;
                            
                            const marker = L.marker(
                                [stop.coordinates.latitude, stop.coordinates.longitude],
                                { icon: createMarkerIcon(isFirst || isLast ? 'stop' : 'intermediate') }
                            ).addTo(map);
                            
                            let popupText = `<div class="popup-title">${stop.name}</div>`;
                            if (isFirst) {
                                popupText += `<div class="popup-detail">Board Bus ${route.bus_line}</div>`;
                            } else if (isLast) {
                                popupText += `<div class="popup-detail">Exit Bus ${route.bus_line}</div>`;
                            } else {
                                popupText += `<div class="popup-detail">Stop #${stop.number}</div>`;
                            }
                            marker.bindPopup(popupText);
                            routeLayers.push(marker);
                        });
                    }
                    
                    // Walking to end - fetch OSRM path
                    let walkToEndPath = route.walking?.from_end_path;
                    if (!walkToEndPath || walkToEndPath.length === 0) {
                        walkToEndPath = await fetchWalkingPath(
                            route.end_stop.coordinates.latitude, route.end_stop.coordinates.longitude,
                            endCoords[0], endCoords[1]
                        );
                        // Cache it
                        if (route.walking) route.walking.from_end_path = walkToEndPath;
                    }
                    
                    if (walkToEndPath && walkToEndPath.length > 0) {
                        const walkToEnd = L.polyline(walkToEndPath, {
                            color: '#C67B5C',
                            weight: 4,
                            dashArray: '8, 8',
                            opacity: 0.8
                        }).addTo(map);
                        routeLayers.push(walkToEnd);
                    } else {
                        // Fallback straight line
                        const walkToEnd = L.polyline([
                            [route.end_stop.coordinates.latitude, route.end_stop.coordinates.longitude],
                            endCoords
                        ], {
                            color: '#C67B5C',
                            weight: 4,
                            dashArray: '8, 8',
                            opacity: 0.8
                        }).addTo(map);
                        routeLayers.push(walkToEnd);
                    }
                }
            }
            
            fitMapToRoute();
        }
        
        function fitMapToRoute() {
            const bounds = L.latLngBounds([startCoords, endCoords]);
            routeLayers.forEach(layer => {
                if (layer.getLatLng) {
                    bounds.extend(layer.getLatLng());
                } else if (layer.getBounds) {
                    bounds.extend(layer.getBounds());
                }
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // ============================================================
        // UI Helpers
        // ============================================================
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('visible', show);
                if (show) {
                    document.getElementById('results-container').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'none';
                }
        }
        
        function showEmptyResults(message = null) {
            const defaultMessage = "Aucun itinéraire de bus trouvé entre ces emplacements.";
            const displayMessage = message || defaultMessage;
            
            // Hide loading
            document.getElementById('loading').classList.remove('visible');
            
            // Clear results container
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('results-container').style.display = 'none';
            
            // Show empty state with message
            const emptyState = document.getElementById('empty-state');
            emptyState.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9.172 16.172a4 4 0 0 1 5.656 0M9 10h.01M15 10h.01M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path>
                </svg>
                <h3>Aucun Itinéraire Trouvé</h3>
                <p>${displayMessage}</p>
                <div class="disclaimer-text" style="margin-top: 1rem;">
                    💡 Conseil : Essayez des adresses plus proches des grandes artères ou des arrêts de bus connus.
                </div>
            `;
            emptyState.style.display = 'flex';
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }
        
        function hideError() {
            document.getElementById('error-message').classList.remove('visible');
        }
        
        // ============================================================
        // Event Listeners
        // ============================================================
        
        document.addEventListener('DOMContentLoaded', () => {
    initMap();
    // Initialize autocomplete
    setupAutocomplete('start');
    setupAutocomplete('end');
    
    // AUTO-PROMPT FOR LOCATION PERMISSION
    // Only prompts if user hasn't decided yet, waits 2 seconds for better UX
    setTimeout(() => {
        if (navigator.permissions && navigator.geolocation) {
            navigator.permissions.query({ name: 'geolocation' }).then(result => {
                if (result.state === 'prompt') {
                    // User hasn't decided yet - show prompt
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('✅ Location permission granted');
                        },
                        (error) => {
                            if (error.code === error.PERMISSION_DENIED) {
                                console.log('ℹ️ User denied location access');
                            }
                        },
                        { timeout: 5000, enableHighAccuracy: false }
                    );
                } else if (result.state === 'granted') {
                    console.log('✅ Location permission already granted');
                } else {
                    console.log('ℹ️ Location permission denied previously');
                }
            }).catch(() => {
                // Fallback for browsers without permissions API
                navigator.geolocation.getCurrentPosition(
                    () => console.log('✅ Location granted'),
                    () => console.log('ℹ️ Location denied'),
                    { timeout: 5000 }
                );
            });
        }
    }, 2000); // Wait 2 seconds before auto-prompting
    
    // Search button
    document.getElementById('btn-search').addEventListener('click', searchRoutes);
    
    // GPS buttons
    document.getElementById('btn-gps-start').addEventListener('click', () => getCurrentLocation('start'));
    document.getElementById('btn-gps-end').addEventListener('click', () => getCurrentLocation('end'));
    
    
    // Enter key on inputs
    document.getElementById('start-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('end-input').focus();
        }
    });
    
    document.getElementById('end-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchRoutes();
        }
    });
});    
    </script>
</body>
</html>
