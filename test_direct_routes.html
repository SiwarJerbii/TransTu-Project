<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransTu - Direct Route Finder Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #e0e0e0;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #34495e;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .marker-info {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #3498db;
        }
        
        .marker-info.start {
            border-left-color: #27ae60;
        }
        
        .marker-info.end {
            border-left-color: #e74c3c;
        }
        
        .marker-info strong {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .marker-info span {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-clear {
            background: #e74c3c;
            color: white;
        }
        
        .btn-clear:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        #map {
            height: 100vh;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .route-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .route-card.valid {
            border-left-color: #27ae60;
        }
        
        .route-card.invalid {
            border-left-color: #e74c3c;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .route-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .route-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-valid {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-invalid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .route-details {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .route-details div {
            margin: 5px 0;
        }
        
        .route-path {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .stop-arrow {
            color: #3498db;
            margin: 0 5px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .instruction {
            background: #fff3cd;
            padding: 12px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-box {
            background: white;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>üöå TransTu Route Finder</h1>
            
            <div class="section">
                <div class="instruction">
                    <strong>üìç Instructions:</strong><br>
                    1. Click on map to set START (green)<br>
                    2. Click again to set END (red)<br>
                    3. Click "Find Routes" to see results
                </div>
            </div>
            
            <div class="section">
                <h2>üìç Selected Locations</h2>
                <div id="startInfo" class="marker-info start" style="display: none;">
                    <strong>üü¢ Start Location</strong>
                    <span id="startCoords"></span>
                </div>
                <div id="endInfo" class="marker-info end" style="display: none;">
                    <strong>üî¥ End Location</strong>
                    <span id="endCoords"></span>
                </div>
                <button class="btn btn-primary" id="findBtn" disabled>Find Direct Routes</button>
                <button class="btn btn-clear" id="clearBtn">Clear Selection</button>
            </div>
            
            <div class="section">
                <h2>üìä Results</h2>
                <div id="results"></div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <script>
        // ========================================
        // BUS DATA - Bus 23 Aller & Retour
        // ========================================
        const BUS_DATA = {
            "type": "bus",
            "routes": [
                {
                    "id": "bus_23_aller",
                    "bus_name": "23",
                    "direction": "aller",
                    "stops": [
                        {"stop_number": 1, "stop_name": "RABATTEMENT SLIMEN KAHIA", "longitude": 10.0985919086815, "latitude": 36.8038638702676},
                        {"stop_number": 2, "stop_name": "ABDELMOULA-ALLER", "longitude": 10.100555151439, "latitude": 36.7959898589052},
                        {"stop_number": 3, "stop_name": "P√âPINI√âRE-ALLER", "longitude": 10.0944179893849, "latitude": 36.7927628745637},
                        {"stop_number": 4, "stop_name": "GARDE NATIONAL AGBA-ALLER", "longitude": 10.0909771172882, "latitude": 36.7904465094472},
                        {"stop_number": 5, "stop_name": "AGBA SUPERIEUR-ALLER", "longitude": 10.0884129256337, "latitude": 36.7895550855675},
                        {"stop_number": 6, "stop_name": "CANAL AGBA-ALLER", "longitude": 10.085432857013, "latitude": 36.7884720453125},
                        {"stop_number": 7, "stop_name": "BEN MAHMOUD-ALLER", "longitude": 10.0814901440026, "latitude": 36.7859248427864},
                        {"stop_number": 8, "stop_name": "CITE ELWAHA-ALLER", "longitude": 10.0760318486572, "latitude": 36.7834694982478},
                        {"stop_number": 9, "stop_name": "SONEDE AGBA-ALLER", "longitude": 10.0699351875664, "latitude": 36.7822278331327},
                        {"stop_number": 10, "stop_name": "GHDIR ELGOLLAH-ALLER", "longitude": 10.0632992682221, "latitude": 36.7801113704086},
                        {"stop_number": 11, "stop_name": "CITE JABRI-ALLER", "longitude": 10.0582461206795, "latitude": 36.7765133357302},
                        {"stop_number": 12, "stop_name": "CROISEMENT BEN YEDDER-ALLER", "longitude": 10.0545902697922, "latitude": 36.774536793894},
                        {"stop_number": 13, "stop_name": "CITE ENNACR-ALLER", "longitude": 10.0268692375539, "latitude": 36.7661324845496},
                        {"stop_number": 14, "stop_name": "MARCH√â MORNAGIAA-ALLER", "longitude": 10.0112644133332, "latitude": 36.7637912490418},
                        {"stop_number": 15, "stop_name": "GUITOUNI-ALLER", "longitude": 9.98007032249006, "latitude": 36.7518733897935},
                        {"stop_number": 16, "stop_name": "CROISEMENT SIDI ALI HATTAB-ALLER", "longitude": 9.97323578543728, "latitude": 36.7491216614083},
                        {"stop_number": 17, "stop_name": "ZONE INDUSTRIELLE-ALLER", "longitude": 9.94505113572813, "latitude": 36.7362428451204},
                        {"stop_number": 18, "stop_name": "AEROPORT BORJ EL AMRI-ALLER", "longitude": 9.93428501460584, "latitude": 36.7307966396709},
                        {"stop_number": 19, "stop_name": "BORJ KHALSI-ALLER", "longitude": 9.92590042922529, "latitude": 36.7269701352987},
                        {"stop_number": 20, "stop_name": "BOUHALLEB-ALLER", "longitude": 9.91590651876322, "latitude": 36.7229155524599},
                        {"stop_number": 21, "stop_name": "CIMETIERE ANGLAIS-ALLER", "longitude": 9.91103562719217, "latitude": 36.7219738954876},
                        {"stop_number": 22, "stop_name": "RELAIS BORJ EL AMRI-ALLER", "longitude": 9.89444884631666, "latitude": 36.7181985520683},
                        {"stop_number": 23, "stop_name": "MOSQU√âE BORJ EL AMRI-ALLER", "longitude": 9.88879474971327, "latitude": 36.7163538122316},
                        {"stop_number": 24, "stop_name": "CAFE MEDINA-ALLER", "longitude": 9.88320502612623, "latitude": 36.7131243359079},
                        {"stop_number": 25, "stop_name": "CITE EL INTILAKA", "longitude": 9.87822121329372, "latitude": 36.7188555955056}
                    ]
                },
                {
                    "id": "bus_23_retour",
                    "bus_name": "23",
                    "direction": "retour",
                    "stops": [
                        {"stop_number": 1, "stop_name": "CITE EL INTILAKA", "longitude": 9.87822121329372, "latitude": 36.7188555955056},
                        {"stop_number": 2, "stop_name": "CAFE MEDINA 23/", "longitude": 9.88236817691358, "latitude": 36.7126728003639},
                        {"stop_number": 3, "stop_name": "MOSQU√âE BORJ EL AMRI-RETOUR", "longitude": 9.88878938562265, "latitude": 36.7161947067207},
                        {"stop_number": 4, "stop_name": "RELAIS BORJ EL AMRI-RETOUR", "longitude": 9.89342424247297, "latitude": 36.7178373477559},
                        {"stop_number": 5, "stop_name": "CIMETIERE ANGLAIS-RETOUR", "longitude": 9.91111072871717, "latitude": 36.7218148016171},
                        {"stop_number": 6, "stop_name": "BOUHALLEB-RETOUR", "longitude": 9.91611573106638, "latitude": 36.7228596553364},
                        {"stop_number": 7, "stop_name": "BORJ KHALSI-RETOUR", "longitude": 9.92647951788967, "latitude": 36.7270337685623},
                        {"stop_number": 8, "stop_name": "AEROPORT BORJ EL AMRI-RETOUR", "longitude": 9.93530935062153, "latitude": 36.731092433294},
                        {"stop_number": 9, "stop_name": "ZONE INDUSTRIELLE-RETOUR", "longitude": 9.94534644491068, "latitude": 36.7361706214847},
                        {"stop_number": 10, "stop_name": "CROISEMENT SIDI ALI HATTAB-RETOUR", "longitude": 9.97336453212483, "latitude": 36.7487606024211},
                        {"stop_number": 11, "stop_name": "GUITOUNI-RETOUR", "longitude": 9.98031681789143, "latitude": 36.7518123559094},
                        {"stop_number": 12, "stop_name": "MARCH√â MORNAGIAA-RETOUR", "longitude": 10.0113395151856, "latitude": 36.7636623243024},
                        {"stop_number": 13, "stop_name": "CITE ENNACER-RETOUR", "longitude": 10.027255475652, "latitude": 36.7660293479242},
                        {"stop_number": 14, "stop_name": "CROISEMENT BEN YEDDER-RETOUR", "longitude": 10.0548719017388, "latitude": 36.7744487076584},
                        {"stop_number": 15, "stop_name": "CITE JABRI-RETOUR", "longitude": 10.0588146147492, "latitude": 36.7766396608083},
                        {"stop_number": 16, "stop_name": "GHDIR ELGOLLAH-RETOUR", "longitude": 10.0636533201395, "latitude": 36.7799438038132},
                        {"stop_number": 17, "stop_name": "SONEDE AGBA-RETOUR", "longitude": 10.0701953618408, "latitude": 36.7821397556369},
                        {"stop_number": 18, "stop_name": "CITE ELWAHA-RETOUR", "longitude": 10.0761659592717, "latitude": 36.7832826052841},
                        {"stop_number": 19, "stop_name": "BEN MAHMOUD-RETOUR", "longitude": 10.0817047207237, "latitude": 36.7857809183742},
                        {"stop_number": 20, "stop_name": "CANAL AGBA-RETOUR", "longitude": 10.0857976374391, "latitude": 36.78843338043},
                        {"stop_number": 21, "stop_name": "AGBA SUPERIEUR-RETOUR", "longitude": 10.0884422955277, "latitude": 36.7893312613464},
                        {"stop_number": 22, "stop_name": "GARDE NATIONAL AGBA-RETOUR", "longitude": 10.0913097113698, "latitude": 36.7904722853714},
                        {"stop_number": 23, "stop_name": "P√âPINI√âRE-RETOUR", "longitude": 10.094901055163, "latitude": 36.7928453546296},
                        {"stop_number": 24, "stop_name": "ABDELMOULA-RETOUR", "longitude": 10.1008287367585, "latitude": 36.7958609883814},
                        {"stop_number": 25, "stop_name": "OUED GUERIANA L23", "longitude": 10.1051472276776, "latitude": 36.7985289949229},
                        {"stop_number": 26, "stop_name": "RABATTEMENT SLIMEN KAHIA", "longitude": 10.0985919086815, "latitude": 36.8038638702676}
                    ]
                }
            ]
        };

        // ========================================
        // CORE ALGORITHM: Direct Route Finder
        // ========================================
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function findNearestStop(lat, lon, route, maxDistance = 500) {
            let nearest = null;
            let minDistance = Infinity;
            
            for (const stop of route.stops) {
                const distance = haversineDistance(lat, lon, stop.latitude, stop.longitude);
                if (distance < minDistance && distance <= maxDistance) {
                    minDistance = distance;
                    nearest = {
                        ...stop,
                        distance: distance
                    };
                }
            }
            
            return nearest;
        }

        function canTravelBetweenStops(route, startStop, endStop) {
            if (!startStop || !endStop) {
                return {
                    valid: false,
                    reason: "Stop not found on this route"
                };
            }
            
            if (startStop.stop_number === endStop.stop_number) {
                return {
                    valid: false,
                    reason: "Start and end are the same stop"
                };
            }
            
            if (endStop.stop_number > startStop.stop_number) {
                return {
                    valid: true,
                    stopsCount: endStop.stop_number - startStop.stop_number,
                    estimatedMinutes: (endStop.stop_number - startStop.stop_number) * 3
                };
            } else {
                return {
                    valid: false,
                    reason: "Would require traveling backwards (try opposite direction)"
                };
            }
        }

        function findDirectRoutes(startLat, startLon, endLat, endLon) {
            const results = [];
            
            for (const route of BUS_DATA.routes) {
                const startStop = findNearestStop(startLat, startLon, route);
                const endStop = findNearestStop(endLat, endLon, route);
                
                if (startStop && endStop) {
                    const validation = canTravelBetweenStops(route, startStop, endStop);
                    
                    results.push({
                        busLine: route.bus_name,
                        direction: route.direction,
                        routeId: route.id,
                        startStop: startStop,
                        endStop: endStop,
                        validation: validation,
                        walkingToStart: Math.round(startStop.distance),
                        walkingToEnd: Math.round(endStop.distance)
                    });
                }
            }
            
            return results;
        }

        // ========================================
        // MAP & UI LOGIC
        // ========================================
        
        let map, startMarker, endMarker;
        let startCoords = null, endCoords = null;
        let stopsLayer;

        // Initialize map
        map = L.map('map').setView([36.77, 10.00], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        stopsLayer = L.layerGroup().addTo(map);

        // Draw all bus stops
        BUS_DATA.routes.forEach(route => {
            route.stops.forEach(stop => {
                const color = route.direction === 'aller' ? '#3498db' : '#e74c3c';
                L.circleMarker([stop.latitude, stop.longitude], {
                    radius: 4,
                    fillColor: color,
                    color: 'white',
                    weight: 1,
                    fillOpacity: 0.7
                }).bindPopup(`
                    <strong>${stop.stop_name}</strong><br>
                    Bus ${route.bus_name} (${route.direction})<br>
                    Stop #${stop.stop_number}
                `).addTo(stopsLayer);
            });
        });

        // Map click handler
        map.on('click', function(e) {
            if (!startCoords) {
                startCoords = e.latlng;
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                    icon: L.divIcon({
                        html: 'üü¢',
                        className: 'emoji-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                document.getElementById('startInfo').style.display = 'block';
                document.getElementById('startCoords').textContent = 
                    `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                
            } else if (!endCoords) {
                endCoords = e.latlng;
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                    icon: L.divIcon({
                        html: 'üî¥',
                        className: 'emoji-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                document.getElementById('endInfo').style.display = 'block';
                document.getElementById('endCoords').textContent = 
                    `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                document.getElementById('findBtn').disabled = false;
            }
        });

        // Find routes button
        document.getElementById('findBtn').addEventListener('click', function() {
            const results = findDirectRoutes(
                startCoords.lat, startCoords.lng,
                endCoords.lat, endCoords.lng
            );
            
            displayResults(results);
        });

        // Clear button
        document.getElementById('clearBtn').addEventListener('click', function() {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            startCoords = null;
            endCoords = null;
            document.getElementById('startInfo').style.display = 'none';
            document.getElementById('endInfo').style.display = 'none';
            document.getElementById('findBtn').disabled = true;
            document.getElementById('results').innerHTML = '';
        });

        function displayResults(results) {
            const container = document.getElementById('results');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">No routes found within walking distance (500m)</div>';
                return;
            }

            let html = '';
            
            results.forEach((result, index) => {
                const isValid = result.validation.valid;
                const cardClass = isValid ? 'valid' : 'invalid';
                const badgeClass = isValid ? 'badge-valid' : 'badge-invalid';
                const status = isValid ? '‚úÖ VALID' : '‚ùå INVALID';
                
                html += `
                    <div class="route-card ${cardClass}">
                        <div class="route-header">
                            <div class="route-title">Bus ${result.busLine} (${result.direction})</div>
                            <span class="route-badge ${badgeClass}">${status}</span>
                        </div>
                        <div class="route-details">
                            <div><strong>üìç Board at:</strong> ${result.startStop.stop_name} (#${result.startStop.stop_number})</div>
                            <div><strong>üöè Exit at:</strong> ${result.endStop.stop_name} (#${result.endStop.stop_number})</div>
                            <div><strong>üö∂ Walk to start:</strong> ${result.walkingToStart}m</div>
                            <div><strong>üö∂ Walk from end:</strong> ${result.walkingToEnd}m</div>
                            ${isValid ? `
                                <div class="stats">
                                    <div class="stat-box">
                                        <div class="stat-value">${result.validation.stopsCount}</div>
                                        <div class="stat-label">Stops</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value">${result.validation.estimatedMinutes}</div>
                                        <div class="stat-label">Minutes</div>
                                    </div>
                                </div>
                            ` : `
                                <div style="color: #e74c3c; margin-top: 10px;">
                                    <strong>‚ùå Reason:</strong> ${result.validation.reason}
                                </div>
                            `}
                        </div>
                        ${isValid ? `
                            <div class="route-path">
                                Stop ${result.startStop.stop_number} 
                                <span class="stop-arrow">‚Üí‚Üí‚Üí</span> 
                                (${result.validation.stopsCount} stops) 
                                <span class="stop-arrow">‚Üí‚Üí‚Üí</span> 
                                Stop ${result.endStop.stop_number}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>